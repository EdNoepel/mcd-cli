#!/usr/bin/env bash
### mcd-gem -- Collateral balances
### Usage: mcd gem --ilk=<id> [<command>]
###
### Commands: balance [<address>]
###           locked [<address>]
###           free [<address>]
###           join <wad>
###           exit <wad>
###
### With `balance' get gem balances for a given address (default: ETH_FROM).
### With `join' add collateral to the system.
### With `exit' remove collateral from the system.
###
### Example: mcd --ilk=ETH gem balance
###          mcd --ilk=ETH gem join 42
set -e

[ ! -z "$MCD_ILK" ] || mcd --fail "$0: Missing Ilk identifier"
ilk=$(seth --to-bytes32 $(seth --from-ascii "$MCD_ILK"))

case $1 in
  balance) {
    locked=$(mcd gem locked $2); free=$(mcd gem free $2)
    echo "locked: $locked"
    echo "free: $free"
    echo "total: $(bc <<< "$locked + $free")"
  };;
  locked) {
    urn=$(seth --to-bytes32 ${2:-$ETH_FROM})
    urn=$(seth call "${MCD_VAT}" 'urns(bytes32,bytes32)(uint256,uint256)' "$ilk" "$urn")
    ink=$(mcd --to-wad ${urn:0:64})
    echo "$ink"
  };;
  free) {
    urn=$(seth --to-bytes32 ${2:-$ETH_FROM})
    gem=$(seth call $MCD_VAT 'gem(bytes32,bytes32)(uint256)' "$ilk" "$urn")
    echo $(mcd --to-rad $gem)
  };;
  join) {
    [[ $ETH_FROM ]] || mcd --fail "$0: You must set ETH_FROM or specify an urn address";
    mcd gem-join $2
  };;
  exit) {
    [[ $ETH_FROM ]] || mcd --fail "$0: You must set ETH_FROM or specify an urn address";
    mcd gem-exit $2
  };;
  *) {
    mcd help gem
  }
esac
