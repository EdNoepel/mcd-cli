#!/usr/bin/env bash
### mcd-gem -- Collateral management
### Usage: mcd --ilk=<id> [--urn=<id>] gem [<arg>]
###
### Commands: balance
###           join <wad>
###           exit <wad>
###
### With `balance' get gem balances for a given address (default: ETH_FROM).
### With `join' add collateral to the system.
### With `exit' remove collateral from the system.
###
### Example: mcd --ilk=ETH gem balance
###          mcd --ilk=ETH gem join 42
set -e
ilk=$(mcd --require-ilk $0)

p() { printf "%-4s %-48s %-10s\n" "$1" "$2" "$3"; }

case $1 in
  balance) {
    urn=$(mcd --require-urn $0)
    case $2 in
      vat) {
        sig="gem(bytes32,bytes32)(uint256)"
        mcd --to-rad $(seth call ${MCD_VAT?} "$sig" "$ilk" "$urn")
      };;
      ink) { mcd --ilk=${MCD_ILK} urn ink; };;
      ext) { mcd gem-balance-ext $urn; };;
      "")   {
        exec 3< <(mcd gem balance vat)
        exec 4< <(mcd gem balance ink)
        exec 5< <(mcd gem balance ext)
        p "vat" $(cat <&3) "Free collateral ($MCD_ILK)"
        p "ink" $(cat <&4) "Locked collateral ($MCD_ILK)"
        p "ext" $(cat <&5) "External account balance ($MCD_ILK)"
      };;
      *)   { mcd gem balance; };;
    esac
  };;
  join) { mcd gem-join $2; };;
  exit) { mcd gem-exit $2; };;
  *)    { mcd help gem; }
esac
