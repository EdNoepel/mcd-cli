#!/usr/bin/env bash
### mcd-urn -- CDP state
### Usage: mcd urn --ilk=<id> [--urn=<address>] [<arg>]
###
### Display the status of the urn at ETH_FROM or
### at a given urn address if provided.
###
### With no arguments, list all parameters
### With `<arg>` get a specified Urn parameter
set -e

[ ! -z "$MCD_URN" ] || [ ! -z "$ETH_FROM" ] ||
  mcd --fail "$0: ETH_FROM or --urn=<bytes32> is required"

ilk=$(mcd --require-ilk $0)
urn=$(seth --to-bytes32 ${MCD_URN:-$ETH_FROM})

vat()  { mcd --vat-urn $ilk $urn; }

p() { printf "%-4s %-64s %-10s\n" "$1" "$2" "$3"; }

calc() {
  spot=$(cat <&3); ink=$(cat <&5)
  rate=$(cat <&4); art=$(cat <&6)
  fill=0
  if [ ${art:0:1} -gt 0 ]; then
    fill=$(bc <<< "scale=2; (($ink*$spot)/($art*$rate)) * 100")
    fill=$(bc <<< "$fill / 1")
  fi
}

mcd-urn() {
  exec 3< <(mcd ilk spot)
  exec 4< <(mcd ilk rate)
  exec 5< <(mcd urn ink)
  exec 6< <(mcd ilk art)
  calc
  p "ilk"  $MCD_ILK "CDP type identifier"
  p "urn"  $urn     "CDP identifier"
  p "ink"  $ink     "Locked collateral ($MCD_ILK)"
  p "art"  $art     "Outstanding debt (DAI)"
  p "spot" $spot    "Price with safety margin (USD)"
  p "rate" $rate    "Debt scaling factor"
  p "fill" $fill    "Collateralization Ratio (%)"
}

case $1 in
  ink)  { vat | mcd --to-wad $(mcd --slice 0 64);   };;
  art)  { vat | mcd --to-wad $(mcd --slice 65 129); };;
  spot) { mcd urn spot;                             };; # alias for consistency
  rate) { mcd urn rate;                             };; # alias for consistency
  "")   { mcd-urn;                                  };;
  *)    { mcd help urn;                             }
esac
